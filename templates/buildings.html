<!--
  文件名: templates/buildings.html
  说明: 公寓楼管理页面 - 增强查询功能
-->

{% extends "base.html" %}

{% block title %}公寓楼管理 - 学生公寓管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-building"></i> 公寓楼管理</h2>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBuildingModal">
            <i class="bi bi-plus-lg"></i> 添加公寓楼
        </button>
    </div>
</div>

<!-- 搜索栏 -->
<div class="card mb-3 shadow-sm">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-search"></i> 公寓楼查询</h6>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('buildings') }}" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">公寓楼号</label>
                <input type="text" class="form-control" name="building_id" value="{{ filters.building_id }}"
                       placeholder="公寓楼号">
            </div>
            <div class="col-md-2">
                <label class="form-label">楼层数</label>
                <input type="number" class="form-control" name="floors" value="{{ filters.floors }}"
                       placeholder="楼层数" min="1" max="50">
            </div>
            <div class="col-md-2">
                <label class="form-label">规划房间数</label>
                <input type="number" class="form-control" name="rooms_count" value="{{ filters.rooms_count }}"
                       placeholder="规划房间数" min="1" max="500">
            </div>
            <div class="col-md-2">
                <label class="form-label">实际房间数</label>
                <input type="number" class="form-control" name="actual_rooms" value="{{ filters.actual_rooms }}"
                       placeholder="实际房间数" min="0" max="500">
            </div>
            <div class="col-md-2">
                <label class="form-label">启用时间</label>
                <input type="date" class="form-control" name="commission_date" value="{{ filters.commission_date }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">入住学生数</label>
                <input type="number" class="form-control" name="student_count" value="{{ filters.student_count }}"
                       placeholder="入住学生数" min="0" max="5000">
            </div>
            <div class="col-md-4 d-flex gap-2 align-items-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 查询
                </button>
                <a href="{{ url_for('buildings') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i> 重置
                </a>
            </div>
        </form>
    </div>
</div>

<!-- 统计信息 -->
{% if filters.building_id or filters.floors or filters.rooms_count or filters.actual_rooms or filters.commission_date or filters.student_count %}
<div class="alert alert-info mb-3">
    <i class="bi bi-info-circle"></i>
    查询结果：共找到 <strong>{{ buildings|length }}</strong> 栋公寓楼
</div>
{% endif %}

<div class="row g-4">
    {% for building in buildings %}
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-building"></i> {{ building.building_id }}</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">楼层数:</dt>
                    <dd class="col-sm-7">{{ building.floors }} 层</dd>

                    <dt class="col-sm-5">规划房间数:</dt>
                    <dd class="col-sm-7">{{ building.rooms_count }} 间</dd>

                    <dt class="col-sm-5">实际房间数:</dt>
                    <dd class="col-sm-7">
                        <span class="badge bg-info">{{ building.actual_rooms }} 间</span>
                    </dd>

                    <dt class="col-sm-5">入住学生:</dt>
                    <dd class="col-sm-7">
                        <span class="badge bg-success">{{ building.student_count }} 人</span>
                    </dd>

                    <dt class="col-sm-5">启用时间:</dt>
                    <dd class="col-sm-7">{{ building.commission_date }}</dd>
                </dl>
            </div>
            <div class="card-footer bg-white">
                <div class="btn-group btn-group-sm w-100" role="group">
                    <button class="btn btn-outline-primary"
                            onclick="editBuilding('{{ building.building_id }}', {{ building.floors }}, {{ building.rooms_count }}, '{{ building.commission_date }}')">
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                    <a href="{{ url_for('rooms', building=building.building_id) }}" class="btn btn-outline-info">
                        <i class="bi bi-door-closed"></i> 查看寝室
                    </a>
                    <button class="btn btn-outline-danger"
                            onclick="confirmDeleteBuilding('{{ building.building_id }}', {{ building.student_count }})">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i>
            暂无公寓楼信息，请点击"添加公寓楼"按钮添加
        </div>
    </div>
    {% endfor %}
</div>

<!-- 添加公寓楼模态框 -->
<div class="modal fade" id="addBuildingModal" tabindex="-1" aria-labelledby="addBuildingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addBuildingModalLabel">
                    <i class="bi bi-building"></i> 添加公寓楼
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_building') }}" onsubmit="return validateBuildingForm(this)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addBuildingId" class="form-label">公寓楼号 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addBuildingId" name="building_id"
                               required maxlength="20" placeholder="例如: A栋, 1号楼">
                        <div class="form-text">建议使用简短易记的名称，创建后不可修改</div>
                    </div>
                    <div class="mb-3">
                        <label for="addFloors" class="form-label">楼层数 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="addFloors" name="floors"
                               required min="1" max="50" value="6">
                    </div>
                    <div class="mb-3">
                        <label for="addRoomsCount" class="form-label">房间数 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="addRoomsCount" name="rooms_count"
                               required min="1" max="500" value="120">
                        <div class="form-text">规划的房间总数</div>
                    </div>
                    <div class="mb-3">
                        <label for="addCommissionDate" class="form-label">启用时间 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="addCommissionDate" name="commission_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 添加
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑公寓楼模态框 -->
<div class="modal fade" id="editBuildingModal" tabindex="-1" aria-labelledby="editBuildingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="editBuildingModalLabel">
                    <i class="bi bi-pencil-square"></i> 编辑公寓楼信息
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editBuildingForm" onsubmit="return validateBuildingForm(this)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editBuildingId" class="form-label">公寓楼号</label>
                        <input type="text" class="form-control" id="editBuildingId" name="building_id" readonly>
                        <div class="form-text text-warning">楼号创建后不可修改</div>
                    </div>
                    <div class="mb-3">
                        <label for="editFloors" class="form-label">楼层数 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editFloors" name="floors"
                               required min="1" max="50">
                    </div>
                    <div class="mb-3">
                        <label for="editRoomsCount" class="form-label">房间数 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editRoomsCount" name="rooms_count"
                               required min="1" max="500">
                    </div>
                    <div class="mb-3">
                        <label for="editCommissionDate" class="form-label">启用时间 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="editCommissionDate" name="commission_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 设置默认日期为今天
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('addCommissionDate');
    if (dateInput && !dateInput.value) {
        dateInput.value = today;
    }
});

// 编辑公寓楼
function editBuilding(id, floors, roomsCount, commissionDate) {
    document.getElementById('editBuildingId').value = id;
    document.getElementById('editFloors').value = floors;
    document.getElementById('editRoomsCount').value = roomsCount;
    document.getElementById('editCommissionDate').value = commissionDate;
    document.getElementById('editBuildingForm').action = `/buildings/edit/${encodeURIComponent(id)}`;

    const modal = new bootstrap.Modal(document.getElementById('editBuildingModal'));
    modal.show();
}

// 确认删除公寓楼
function confirmDeleteBuilding(id, studentCount) {
    let message = `确定要删除公寓楼 ${id} 吗？\n\n`;

    if (studentCount > 0) {
        message += `⚠️ 警告: 该楼还有 ${studentCount} 名学生入住！\n`;
    }

    message += `此操作将删除该楼所有寝室和相关记录，且不可恢复！`;

    if (confirm(message)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/buildings/delete/${encodeURIComponent(id)}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// 表单验证
function validateBuildingForm(form) {
    const floors = parseInt(form.querySelector('[name="floors"]').value);
    const roomsCount = parseInt(form.querySelector('[name="rooms_count"]').value);

    if (floors < 1 || floors > 50) {
        alert('楼层数必须在 1-50 之间');
        return false;
    }

    if (roomsCount < 1 || roomsCount > 500) {
        alert('房间数必须在 1-500 之间');
        return false;
    }

    // 合理性检查：每层房间数
    const roomsPerFloor = roomsCount / floors;
    if (roomsPerFloor > 50) {
        if (!confirm(`平均每层 ${roomsPerFloor.toFixed(0)} 个房间，数量较多，是否继续？`)) {
            return false;
        }
    }

    return true;
}
</script>
{% endblock %}